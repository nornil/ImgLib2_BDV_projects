<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Tobias Pietzsch">
<meta name="dcterms.date" content="2022-10-30">

<title>ImgLib2 and BigDataviewer projects - Adding Stream support to ImgLib2</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">ImgLib2 and BigDataviewer projects</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html" rel="" target="">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-learning-resources" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Learning Resources</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-learning-resources">    
        <li>
    <a class="dropdown-item" href="../../learning_resources/imglib2_links.html" rel="" target=""><i class="bi bi-info-square" role="img">
</i> 
 <span class="dropdown-text">ImgLib2 links</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../learning_resources/bigdataviewer_links.html" rel="" target=""><i class="bi bi-info-square" role="img">
</i> 
 <span class="dropdown-text">BigDataViewer links</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../../ecosystem.html" rel="" target="">
 <span class="menu-text">Ecosystem</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-contributing-guidelines" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Contributing Guidelines</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-contributing-guidelines">    
        <li>
    <a class="dropdown-item" href="../../contributing_guidelines/guidelines_for_imglib2.html" rel="" target=""><i class="bi bi-share" role="img">
</i> 
 <span class="dropdown-text">Guidelines for ImgLib2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../contributing_guidelines/guidelines_for_bigdataviewer.html" rel="" target=""><i class="bi bi-share" role="img">
</i> 
 <span class="dropdown-text">Guidelines for BigDataViewer</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../contributing_guidelines/our_code_of_conduct.html" rel="" target=""><i class="bi bi-peace" role="img">
</i> 
 <span class="dropdown-text">Our Code-of-conduct</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Adding Stream support to ImgLib2</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">imglib2</div>
                <div class="quarto-category">stream-api</div>
                <div class="quarto-category">java</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Tobias Pietzsch </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">October 30, 2022</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="adding-stream-support-to-imglib2" class="level1">
<h1>Adding Stream support to ImgLib2</h1>
<blockquote class="blockquote">
<p>Examples and a discussion on performance</p>
</blockquote>
<p>The recently released <a href="https://maven.scijava.org/#nexus-search;gav~net.imglib2~imglib2~6.3.0~~">imglib2-6.3.0</a> adds support for Java Streams.</p>
<section id="access-img-pixels-as-a-stream" class="level2">
<h2 class="anchored" data-anchor-id="access-img-pixels-as-a-stream">Access Img pixels as a Stream</h2>
<p>The first addition is that every <code>IterableRealInterval&lt;T&gt;</code> (and sub-classes like <code>IterableInterval</code>, <code>Img</code>, …) can now provide (sequential or parallel) streams over its elements.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;java&quot;}" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">interface</span> IterableRealInterval<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="kw">extends</span> RealInterval<span class="op">,</span> <span class="bu">Iterable</span><span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">...</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    Stream<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="fu">stream</span><span class="op">();</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    Stream<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="fu">parallelStream</span><span class="op">();</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is entirely equivalent to ‘java.util.Collection’</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;java&quot;}" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">interface</span> <span class="bu">Collection</span><span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="kw">extends</span> <span class="bu">Iterable</span><span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">...</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    Stream<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="fu">stream</span><span class="op">();</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    Stream<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="fu">parallelStream</span><span class="op">();</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and allows to operate on pixel values.</p>
<p>Encounter order of the streams is always compatible with <code>cursor()</code>. That is, <code>Views.flatIterable(img).stream()</code> yields elements in flat iteration order.</p>
<p>Streams can be used, for example, to set all pixels of an <code>Img</code> to some <code>value</code>:</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;java&quot;}">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="op">&lt;</span>T <span class="kw">extends</span> <span class="bu">Type</span><span class="op">&lt;</span>T<span class="op">&gt;&gt;</span> <span class="dt">void</span> <span class="fu">fill</span><span class="op">(</span>Img<span class="op">&lt;</span>T<span class="op">&gt;</span> img<span class="op">,</span> T value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    img<span class="op">.</span><span class="fu">stream</span><span class="op">().</span><span class="fu">forEach</span><span class="op">(</span>t<span class="op">-&gt;</span>t<span class="op">.</span><span class="fu">set</span><span class="op">(</span>value<span class="op">));</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>to compute the sum of all values in an <code>Img</code>:</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;java&quot;}">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">double</span> <span class="fu">sum</span><span class="op">(</span>Img<span class="op">&lt;</span>DoubleType<span class="op">&gt;</span> img<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> img<span class="op">.</span><span class="fu">stream</span><span class="op">()</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">mapToDouble</span><span class="op">(</span>DoubleType<span class="op">::</span>get<span class="op">)</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">sum</span><span class="op">();</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>or to find the maximum value in an <code>Img</code>:</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;java&quot;}">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">double</span> <span class="fu">max</span><span class="op">(</span>Img<span class="op">&lt;</span>DoubleType<span class="op">&gt;</span> img<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> img<span class="op">.</span><span class="fu">stream</span><span class="op">()</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">mapToDouble</span><span class="op">(</span>DoubleType<span class="op">::</span>get<span class="op">)</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">max</span><span class="op">().</span><span class="fu">getAsDouble</span><span class="op">();</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In particular the latter two examples, where the terminal operation is some form of reduction, allow for more convenient parallelization than the alternatives. Computing the maximum value in parallel is as simple as</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;java&quot;}">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">double</span> <span class="fu">max</span><span class="op">(</span>Img<span class="op">&lt;</span>DoubleType<span class="op">&gt;</span> img<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> img<span class="op">.</span><span class="fu">parallelStream</span><span class="op">()</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">mapToDouble</span><span class="op">(</span>DoubleType<span class="op">::</span>get<span class="op">)</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">max</span><span class="op">().</span><span class="fu">getAsDouble</span><span class="op">();</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Doing the same with <code>LoopBuilder</code> currently requires to parallelize over chunks, collect partial results into mutable holder objects, and implement the reduction of partial results into the final result.</p>
</section>
<section id="access-img-values-and-positions-as-a-stream" class="level2">
<h2 class="anchored" data-anchor-id="access-img-values-and-positions-as-a-stream">Access Img values <em>and positions</em> as a Stream</h2>
<p>A stream of only pixel values, without access to their positions is rather limiting. For example, we would often be interested in the location of the image maximum, not only the value. To achieve this, there is a new utility class <code>net.imglib2.stream.Streams</code>, with methods</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;java&quot;}">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">static</span> <span class="op">&lt;</span>T<span class="op">&gt;</span> Stream<span class="op">&lt;</span>RealLocalizableSampler<span class="op">&lt;</span>T<span class="op">&gt;&gt;</span> <span class="fu">localizable</span><span class="op">(</span>IterableRealInterval<span class="op">&lt;</span>T<span class="op">&gt;</span> interval<span class="op">)</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">static</span> <span class="op">&lt;</span>T<span class="op">&gt;</span> Stream<span class="op">&lt;</span>RealLocalizableSampler<span class="op">&lt;</span>T<span class="op">&gt;&gt;</span> <span class="fu">localizing</span><span class="op">(</span>IterableRealInterval<span class="op">&lt;</span>T<span class="op">&gt;</span> interval<span class="op">)</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">static</span> <span class="op">&lt;</span>T<span class="op">&gt;</span> Stream<span class="op">&lt;</span>LocalizableSampler<span class="op">&lt;</span>T<span class="op">&gt;&gt;</span> <span class="fu">localizable</span><span class="op">(</span>IterableInterval<span class="op">&lt;</span>T<span class="op">&gt;</span> interval<span class="op">)</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">static</span> <span class="op">&lt;</span>T<span class="op">&gt;</span> Stream<span class="op">&lt;</span>LocalizableSampler<span class="op">&lt;</span>T<span class="op">&gt;&gt;</span> <span class="fu">localizing</span><span class="op">(</span>IterableInterval<span class="op">&lt;</span>T<span class="op">&gt;</span> interval<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>that allow to create Streams of <code>LocalizableSampler&lt;T&gt;</code> of the pixels of an <code>IterableInterval</code> (and analogous for <code>IterableRealInterval</code>). You can think of <code>LocalizableSampler&lt;T&gt;</code> as a <code>Cursor&lt;T&gt;</code> which cannot be moved, which is more or less what the default implementation does under the hood.</p>
<p>The <code>localizable</code> and <code>localizing</code> variants are analogous to <code>cursor()</code> and <code>localizingCursor()</code> The Stream returned by <code>localizable</code> computes element locations only when asked to (with potentially higher per-element cost). The Stream returned by <code>localizing</code> tracks element locations always (in general faster, but potentially unnecessary).</p>
<p>For example, to fill image pixels with position-dependent values, we would use <code>localizing</code>, because we require the position of each element.</p>
<div class="cell" data-scrolled="true" data-vscode="{&quot;languageId&quot;:&quot;java&quot;}" data-execution_count="8">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> <span class="fu">fractal</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    Img<span class="op">&lt;</span>UnsignedByteType<span class="op">&gt;</span> img <span class="op">=</span> ArrayImgs<span class="op">.</span><span class="fu">unsignedBytes</span><span class="op">(</span><span class="dv">1000</span><span class="op">,</span> <span class="dv">1000</span><span class="op">);</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    Streams<span class="op">.</span><span class="fu">localizing</span><span class="op">(</span>img<span class="op">)</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">parallel</span><span class="op">()</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">forEach</span><span class="op">(</span>s <span class="op">-&gt;</span> s<span class="op">.</span><span class="fu">get</span><span class="op">().</span><span class="fu">set</span><span class="op">(</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">mandelbrot</span><span class="op">(</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>                            <span class="op">(</span>s<span class="op">.</span><span class="fu">getDoublePosition</span><span class="op">(</span><span class="dv">0</span><span class="op">)</span> <span class="op">-</span> <span class="dv">800</span><span class="op">)</span> <span class="op">/</span> <span class="dv">500</span><span class="op">,</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>                            <span class="op">(</span>s<span class="op">.</span><span class="fu">getDoublePosition</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">-</span> <span class="dv">500</span><span class="op">)</span> <span class="op">/</span> <span class="dv">500</span><span class="op">)</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>            <span class="op">));</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    BdvFunctions<span class="op">.</span><span class="fu">show</span><span class="op">(</span>img<span class="op">,</span> <span class="st">"mandelbrot"</span><span class="op">,</span> Bdv<span class="op">.</span><span class="fu">options</span><span class="op">().</span><span class="fu">is2D</span><span class="op">());</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="mandelbrot.jpg" title="Mandelbrot" class="img-fluid"></p>
<p>Conversely, to compute the maximum value and its location in an image, we would use <code>localizable</code>, because we only ask for the position of one element (the maximum).</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;java&quot;}">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> <span class="fu">printMax</span><span class="op">(</span>Img<span class="op">&lt;</span>IntType<span class="op">&gt;</span> img<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    Optional<span class="op">&lt;</span>LocalizableSampler<span class="op">&lt;</span>IntType<span class="op">&gt;&gt;</span> optionalMax <span class="op">=</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>            Streams<span class="op">.</span><span class="fu">localizable</span><span class="op">(</span>img<span class="op">)</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">parallel</span><span class="op">()</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">map</span><span class="op">(</span>LocalizableSampler<span class="op">::</span>copy<span class="op">)</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">max</span><span class="op">(</span><span class="bu">Comparator</span><span class="op">.</span><span class="fu">comparingInt</span><span class="op">(</span>c <span class="op">-&gt;</span> c<span class="op">.</span><span class="fu">get</span><span class="op">().</span><span class="fu">get</span><span class="op">()));</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    LocalizableSampler<span class="op">&lt;</span>IntType<span class="op">&gt;</span> max <span class="op">=</span> optionalMax<span class="op">.</span><span class="fu">get</span><span class="op">();</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">"max position = "</span> <span class="op">+</span> <span class="bu">Util</span><span class="op">.</span><span class="fu">printCoordinates</span><span class="op">(</span>max<span class="op">));</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">"max value = "</span> <span class="op">+</span> max<span class="op">.</span><span class="fu">get</span><span class="op">().</span><span class="fu">getInteger</span><span class="op">());</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>(In both cases, it is fine to chose the respectively other variant with no change in behaviour, and only limited performance impact.)</p>
</section>
<section id="pitfalls" class="level2">
<h2 class="anchored" data-anchor-id="pitfalls">Pitfalls</h2>
<p>The <code>T</code> elements of the stream are proxies that are re-used, as usual in ImgLib2. Explicit copying operations must be added if stream elements are supposed to be retained (by stateful intermediate or terminal operations).</p>
<p>For example, to collect all <code>DoubleType</code> values between <code>0</code> and <code>1</code> into a list:</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;java&quot;}">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span><span class="op">&lt;</span> DoubleType <span class="op">&gt;</span> values <span class="op">=</span> img<span class="op">.</span><span class="fu">stream</span><span class="op">()</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span><span class="op">(</span> t <span class="op">-&gt;</span> t<span class="op">.</span><span class="fu">get</span><span class="op">()</span> <span class="op">&gt;=</span> <span class="fl">0.0</span> <span class="op">&amp;&amp;</span> t<span class="op">.</span><span class="fu">get</span><span class="op">()</span> <span class="op">&lt;=</span> <span class="fl">1.0</span> <span class="op">)</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">map</span><span class="op">(</span> DoubleType<span class="op">::</span>copy <span class="op">)</span> <span class="co">// &lt;-- this is important!</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">collect</span><span class="op">(</span> Collectors<span class="op">.</span><span class="fu">toList</span><span class="op">()</span> <span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>.map(DoubleType::copy)</code> operation is necessary, otherwise the <code>values</code> list will contain many duplicates of the same (re-used proxy) <code>DoubleType</code> instance. The copy could also be done before the <code>.filter(...)</code> operation, but it’s better to do it as late as possible to avoid unnecessary creation of objects.</p>
<p>Likewise, the <code>.map(LocalizableSampler::copy)</code> in the <code>printMax()</code> example above is required. There is <a href="https://github.com/orgs/imglib/projects/1/views/1?pane=issue&amp;itemId=38384066">ongoing work</a> to reduce the necessity of explicit copy operations. For example, in the <code>printMax()</code> example, the <code>.max()</code> operation of the stream could be overridden to only copy when a new maximum candidate is encountered.</p>
<p>Note, that already the current implementation takes care not to re-use proxies across parallel execution, so threads of a <code>parallelStream()</code> will not interfere.</p>
</section>
<section id="implementation-details" class="level2">
<h2 class="anchored" data-anchor-id="implementation-details">Implementation details</h2>
<ul>
<li>Both, pure-value streams and value-and-position streams make use of <code>LocalizableSpliterator&lt;T&gt;</code>. <code>LocalizableSpliterator&lt;T&gt;</code> extends <code>Spliterator</code> and <code>Localizable</code>, similiar to <code>Cursor</code> extending <code>Iterator</code> and <code>Localizable</code>.</li>
<li>There are default <code>LocalizableSpliterator&lt;T&gt;</code> (and <code>RealLocalizableSpliterator&lt;T&gt;</code>) implementations based on <code>Cursor&lt;T&gt;</code> (and <code>RealCursor&lt;T&gt;</code>). Therefore, the new streams API works for every <code>IterableRealInterval</code>, without the need to touch existing implementations.</li>
<li>Additionally, the standard <code>Img</code> classes have custom <code>LocalizableSpliterator&lt;T&gt;</code>, that leverage knowledge of underlying storage for improved performance.</li>
</ul>
</section>
<section id="performance" class="level2">
<h2 class="anchored" data-anchor-id="performance">Performance</h2>
<p>It’s complicated…</p>
<p>One the one hand, there comes considerable performance overhead in replacing simple loops with stream operations. This has nothing to do with ImgLib2, it is just a “feature” of the underlying machinery. This can be observed for example by benchmarking looping over an <code>int[]</code> array:</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;java&quot;}">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span><span class="op">[]</span> values <span class="op">=</span> <span class="kw">new</span> <span class="dt">int</span><span class="op">[</span><span class="dv">4_000_000</span><span class="op">];</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="at">@Benchmark</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">long</span> <span class="fu">benchmarkForLoopArray</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">long</span> count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> value <span class="op">:</span> values<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>value <span class="op">&gt;</span> <span class="dv">127</span><span class="op">)</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>            <span class="op">++</span>count<span class="op">;</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> count<span class="op">;</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="at">@Benchmark</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">long</span> <span class="fu">benchmarkStreamArray</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> IntStream<span class="op">.</span><span class="fu">of</span><span class="op">(</span>values<span class="op">).</span><span class="fu">filter</span><span class="op">(</span>value <span class="op">-&gt;</span> value <span class="op">&gt;</span> <span class="dv">127</span><span class="op">).</span><span class="fu">count</span><span class="op">();</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The result is</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;java&quot;}">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>Benchmark                                          Mode  Cnt   Score   <span class="bu">Error</span>  Units</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>ArrayStreamBenchmark<span class="op">.</span><span class="fu">benchmarkForLoopArray</span>         avgt   <span class="dv">15</span>   <span class="dv">2</span><span class="op">,</span><span class="dv">563</span> ± <span class="dv">0</span><span class="op">,</span><span class="bn">026</span>  ms<span class="op">/</span>op</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>ArrayStreamBenchmark<span class="op">.</span><span class="fu">benchmarkStreamArray</span>          avgt   <span class="dv">15</span>  <span class="dv">11</span><span class="op">,</span><span class="bn">052</span> ± <span class="dv">0</span><span class="op">,</span><span class="bn">022</span>  ms<span class="op">/</span>op</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>That is, the Stream version is &gt; 4 times slower. Equivalent performance overhead often can be observed in ImgLib2, when replacing <code>Cursor</code> based loops with Stream operations.</p>
<p>On the other hand, custom Spliterator implementations sometimes benefit more than cursors from tuning to the underlying storage. (Because iteration is “internal” with the spliterator, while the cursor must return control to the caller after every visited element.) For example, consider the following benchmark method (equivalent code for other variations omitted, see <a href="https://github.com/imglib/imglib2/blob/dbade5c32a6900145e578ebde0efc12e7a35c436/src/test/java/net/imglib2/stream/LocalizableSamplerStreamBenchmark.java">github</a> for full details):</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;java&quot;}">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Benchmark</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">long</span> <span class="fu">benchmarkStream</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">long</span> sum <span class="op">=</span> Streams<span class="op">.</span><span class="fu">localizable</span><span class="op">(</span>img<span class="op">)</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">mapToLong</span><span class="op">(</span>s <span class="op">-&gt;</span> s<span class="op">.</span><span class="fu">get</span><span class="op">().</span><span class="fu">get</span><span class="op">()</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>                    <span class="op">+</span> s<span class="op">.</span><span class="fu">getIntPosition</span><span class="op">(</span><span class="dv">0</span><span class="op">)</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>                    <span class="op">+</span> s<span class="op">.</span><span class="fu">getIntPosition</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>                    <span class="op">+</span> s<span class="op">.</span><span class="fu">getIntPosition</span><span class="op">(</span><span class="dv">2</span><span class="op">)</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>            <span class="op">).</span><span class="fu">sum</span><span class="op">();</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sum<span class="op">;</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The result looks like</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;java&quot;}">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Benchmark</span>                                                            <span class="op">(</span>imgType<span class="op">)</span>  Mode  Cnt   Score   <span class="bu">Error</span>  Units</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>LocalizableSamplerStreamBenchmark<span class="op">.</span><span class="fu">benchmarkCursor</span>                     ArrayImg  avgt   <span class="dv">15</span>  <span class="dv">10</span><span class="op">,</span><span class="dv">0</span><span class="er">97</span> ± <span class="dv">0</span><span class="op">,</span><span class="bn">046</span>  ms<span class="op">/</span>op</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>LocalizableSamplerStreamBenchmark<span class="op">.</span><span class="fu">benchmarkLocalizingCursor</span>           ArrayImg  avgt   <span class="dv">15</span>   <span class="dv">3</span><span class="op">,</span><span class="dv">846</span> ± <span class="dv">0</span><span class="op">,</span><span class="bn">020</span>  ms<span class="op">/</span>op</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>LocalizableSamplerStreamBenchmark<span class="op">.</span><span class="fu">benchmarkLocalizingStream</span>           ArrayImg  avgt   <span class="dv">15</span>   <span class="dv">3</span><span class="op">,</span><span class="dv">337</span> ± <span class="dv">0</span><span class="op">,</span><span class="bn">027</span>  ms<span class="op">/</span>op</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>LocalizableSamplerStreamBenchmark<span class="op">.</span><span class="fu">benchmarkLocalizingParallelStream</span>   ArrayImg  avgt   <span class="dv">15</span>   <span class="dv">0</span><span class="op">,</span><span class="dv">962</span> ± <span class="dv">0</span><span class="op">,</span><span class="dv">583</span>  ms<span class="op">/</span>op</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>That is, the performance difference between localizing and non-localizing Cursors is much more pronounced than the difference between Cursor loop and Stream. In fact, the Stream version is even faster than the localizingCursor version. On top of that, it is trivial to parallelize.</p>
<p>Finally, we did not investigate polymorphism effects so far. It is very much possible that this affects performance and we may have to investigate employing <code>LoopBuilder</code>s class-copying mechanism to counter these effects.</p>
<p>In summary, I think one should not hesitate to use Streams where it makes sense from a readability and ease-of-use perspective. If performance is a critical concern, it is best to benchmark various approaches, because the behaviour is not easy to predict.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>